<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de AdministraciÃ³n</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        :root {
            --color-primary: #17a2b8;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-bg: #f4f7f6;
            --color-card: #ffffff;
            --color-text: #333;
            --color-text-light: #555;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-bg);
            margin: 0;
            color: var(--color-text);
        }
        #loader {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--color-bg);
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #main-content { display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .header {
            background-color: var(--color-card); padding: 1rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .header-logo { font-size: 1.5rem; font-weight: 600; color: var(--color-primary); }
        .header-user { display: flex; align-items: center; gap: 1rem; }
        #adminEmail { font-size: 0.9rem; color: var(--color-text-light); font-weight: 600; }
        .btn-logout {
            background: var(--color-danger); color: white; border: none;
            padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;
            font-weight: 500; transition: background-color 0.3s;
        }
        .btn-logout:hover { background-color: #c82333; }
        
        .container { max-width: 900px; margin: 2rem auto; padding: 1rem; }
        .admin-card {
            background-color: var(--color-card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .admin-card h2 {
            margin: 0; padding: 1.5rem 2rem;
            font-weight: 600;
            border-bottom: 2px solid var(--color-bg);
        }
        
        .user-table { width: 100%; border-collapse: collapse; }
        .user-table th, .user-table td {
            padding: 1rem 2rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .user-table th {
            background-color: #f9f9f9; font-weight: 600;
            font-size: 0.9rem; text-transform: uppercase;
        }
        .user-table tr:last-child td { border-bottom: none; }
        .user-table tr:hover { background-color: #f5fafd; }
        
        .user-email { font-weight: 500; }
        .user-saldo {
            font-weight: 600; color: var(--color-primary);
            font-family: monospace; font-size: 1.1rem;
        }
        
        .user-actions .btn-sm {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            margin-left: 0.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-cargar { background-color: var(--color-success); color: white; }
        .btn-cargar:hover { background-color: #218838; }
        .btn-retirar { background-color: var(--color-danger); color: white; }
        .btn-retirar:hover { background-color: #c82333; }
        
        #no-users { padding: 2rem; text-align: center; color: var(--color-text-light); }
        
        .history-list {
            list-style: none; padding: 0 2rem;
            max-height: 400px; overflow-y: auto;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #eee;
        }
        .history-item:last-child { border-bottom: none; }
        .history-details { font-size: 0.9rem; }
        .history-details .date { font-size: 0.8rem; color: #555; display: block; }
        .history-amount { font-weight: 600; }
        
        /* === CSS DEL MODAL === */
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--color-card); color: var(--color-text);
            padding: 2rem; border-radius: 12px; box-shadow: var(--shadow);
            width: 90%; max-width: 400px; text-align: center;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-content h3 { margin-top: 0; }
        .modal-content p { margin-bottom: 1.5rem; font-size: 0.9rem; }
        
        .modal-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-buttons { display: flex; gap: 1rem; }
        .modal-buttons .btn { flex: 1; padding: 0.8rem; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-confirm { background-color: var(--color-success); color: white; border: none; }
        .btn-confirm:hover { background-color: #218838; }
        .btn-cancel { background-color: #6c757d; color: white; border: none; }
        .btn-cancel:hover { background-color: #5a6268; }
        /* === FIN CSS DEL MODAL === */
        
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="main-content">
        <header class="header">
             <div class="header-logo">Panel Admin</div>
            <div class="header-user">
                <span id="adminEmail">cargando...</span>
                <button id="logoutBtn" class="btn-logout">Cerrar SesiÃ³n</button>
            </div>
        </header>

        <div class="container">
             <div class="admin-card">
                <h2>ðŸ“‹ Lista de Usuarios (En Tiempo Real)</h2>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Saldo Actual</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="user-list"></tbody>
                </table>
                <div id="no-users" style="display:none;"><p>No hay usuarios registrados.</p></div>
            </div>
            
            <div class="admin-card" style="margin-top: 2rem;">
                 <h2> Historial General de Transacciones</h2>
                 <ul id="history-list" class="history-list"></ul>
                 <p id="history-empty" style="padding: 1rem 2rem; color: #777;">No hay transacciones en el sistema.</p>
            </div>
        </div>
    </div>
    
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">TÃ­tulo</h3>
            <p id="modalText">Para usuario:</p>
            
            <input type="number" id="modalMonto" class="modal-input" placeholder="0.00">
            
            <div class="modal-buttons">
                <button id="confirmBtn" class="btn btn-confirm">Confirmar</button>
                <button id="cancelBtn" class="btn btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        // --- CONFIGURACIÃ“N E INICIALIZACIÃ“N ---
        const firebaseConfig = {
            apiKey: "AIzaSyCTs3-GGkWTDtuZyxW_1bPnleVFzpZ4WAc",
            authDomain: "simulador-pasarela.firebaseapp.com",
            projectId: "simulador-pasarela",
            storageBucket: "simulador-pasarela.appspot.com",
            messagingSenderId: "288239143779",
            appId: "1:288239143779:web:a994fbdb7698f8ddf8e156"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const increment = firebase.firestore.FieldValue.increment;
        const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

        // --- REFERENCIAS DOM ---
        const adminEmailSpan = document.getElementById("adminEmail");
        const logoutBtn = document.getElementById("logoutBtn");
        const userList = document.getElementById("user-list");
        const noUsersMsg = document.getElementById("no-users");
        const loader = document.getElementById("loader");
        const mainContent = document.getElementById("main-content");
        const globalHistoryList = document.getElementById("history-list");
        const globalHistoryEmpty = document.getElementById("history-empty");
        
        // Referencias del Modal
        const actionModal = document.getElementById("actionModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalText = document.getElementById("modalText");
        const modalMonto = document.getElementById("modalMonto");
        const confirmBtn = document.getElementById("confirmBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        
        let adminUser = null; 

        // --- 1. VERIFICAR AUTENTICACIÃ“N ---
        auth.onAuthStateChanged(async (user) => {
             if (user) {
                const userDoc = await db.collection("usuarios").doc(user.uid).get();
                if (userDoc.exists && userDoc.data().rol === 'cajero') {
                    adminUser = userDoc.data();
                    adminEmailSpan.textContent = `Admin: ${adminUser.email}`;
                    
                    // === ESTAS FUNCIONES YA NO TIENEN EL ERROR DEL "CARGANDO" ===
                    cargarUsuariosEnTiempoReal();
                    cargarHistorialGeneral(); 
                    
                    loader.style.display = 'none';
                    mainContent.style.display = 'block';
                } else if (userDoc.exists) {
                    window.location.href = "index.html";
                } else {
                    auth.signOut();
                }
            } else {
                window.location.href = "login.html";
            }
        });

        // --- 2. CERRAR SESIÃ“N ---
        logoutBtn.addEventListener("click", async () => { await auth.signOut(); });

        // --- 3. CARGAR USUARIOS (Corregido: Sin filtros de DB) ---
        function cargarUsuariosEnTiempoReal() {
            db.collection("usuarios").onSnapshot((querySnapshot) => {
                userList.innerHTML = ""; 
                let userCount = 0;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.rol === 'usuario') { // Filtro en JS
                        userCount++;
                        const uid = doc.id;
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td><span class="user-email">${data.email}</span></td>
                            <td><span class="user-saldo">$${parseFloat(data.saldo).toFixed(2)}</span></td>
                            <td class="user-actions">
                                <button class="btn-sm btn-cargar" data-uid="${uid}" data-email="${data.email}">Cargar</button>
                                <button class="btn-sm btn-retirar" data-uid="${uid}" data-email="${data.email}">Retirar</button>
                            </td>
                        `;
                        userList.appendChild(tr);
                    }
                });
                noUsersMsg.style.display = (userCount === 0) ? "block" : "none";
            });
        }
        
        // --- 4. CARGAR HISTORIAL (Corregido: Sin ordenar en DB) ---
        function cargarHistorialGeneral() {
            db.collection("transacciones").onSnapshot((querySnapshot) => {
                globalHistoryList.innerHTML = "";
                if (querySnapshot.empty) {
                    globalHistoryEmpty.style.display = "block"; return;
                }
                globalHistoryEmpty.style.display = "none";
                
                let transacciones = [];
                querySnapshot.forEach((doc) => transacciones.push(doc.data()));
                
                // Ordenamos en JS
                transacciones.sort((a, b) => (b.fecha ? b.fecha.toMillis() : 0) - (a.fecha ? a.fecha.toMillis() : 0));
                
                const ultimasTransacciones = transacciones.slice(0, 30);
                
                ultimasTransacciones.forEach((data) => {
                    const fecha = data.fecha ? data.fecha.toDate().toLocaleString() : '...';
                    let detalle = '';
                    let montoClase = '';
                    
                    if(data.tipo === 'enviado') {
                        detalle = `<strong>${data.de || 'N/A'}</strong> âž” ${data.a}`;
                    } else if(data.tipo === 'recibido') {
                        return; 
                    } else if(data.tipo === 'carga') {
                        detalle = `<strong>Admin</strong> âž” ${data.de}`;
                        montoClase = 'style="color: var(--color-success);"';
                    } else if(data.tipo === 'retiro') {
                        detalle = `<strong>Admin</strong> âž” ${data.a}`;
                        montoClase = 'style="color: var(--color-danger);"';
                    }
                    
                    const li = document.createElement("li");
                    li.className = "history-item";
                    li.innerHTML = `
                        <div class="history-details">
                            ${detalle}
                            <span class="date">${fecha}</span>
                        </div>
                        <span class="history-amount" ${montoClase}>
                            $${data.monto.toFixed(2)}
                        </span>
                    `;
                    globalHistoryList.appendChild(li);
                });
            });
        }
        
        // --- 5. ACCIONES DE CARGAR Y RETIRAR (Con el Modal) ---
        
        userList.addEventListener("click", async (e) => {
            const target = e.target;
            const uid = target.dataset.uid;
            const email = target.dataset.email;

            if (!uid) return; 

            if (target.classList.contains("btn-cargar")) {
                await modificarSaldo(uid, email, 'cargar');
            }
            if (target.classList.contains("btn-retirar")) {
                await modificarSaldo(uid, email, 'retirar');
            }
        });
        
        function showMontoModal(tipo, email) {
            modalTitle.textContent = `${tipo.charAt(0).toUpperCase() + tipo.slice(1)} Dinero`;
            modalText.textContent = `Usuario: ${email}`;
            modalMonto.value = '';
            actionModal.style.display = "flex";
            modalMonto.focus();

            return new Promise((resolve) => {
                confirmBtn.onclick = () => {
                    const monto = parseFloat(modalMonto.value);
                    if (isNaN(monto) || monto <= 0) {
                        alert("Por favor, ingresa un monto vÃ¡lido.");
                        return; 
                    }
                    actionModal.style.display = "none";
                    resolve(monto); 
                };
                
                cancelBtn.onclick = () => {
                    actionModal.style.display = "none";
                    resolve(null); 
                };
            });
        }
        
        async function modificarSaldo(uid, email, tipo) {
            const monto = await showMontoModal(tipo, email);
            
            if (monto === null) return;
            
            const userRef = db.collection("usuarios").doc(uid);
            
            if(tipo === 'retirar') {
                const userDoc = await userRef.get();
                if(monto > userDoc.data().saldo) {
                    alert("Error: El usuario no tiene fondos suficientes.");
                    return;
                }
            }
            
            const montoFinal = (tipo === 'cargar') ? monto : -monto;
            const historialTipo = (tipo === 'cargar') ? 'carga' : 'retiro';
            const historialDe = (tipo === 'cargar') ? adminUser.email : email;
            const historialA = (tipo === 'cargar') ? email : adminUser.email;
            
            try {
                const batch = db.batch();
                batch.update(userRef, { saldo: increment(montoFinal) });
                
                const historialRef = db.collection("transacciones").doc();
                batch.set(historialRef, {
                    uid: uid,
                    tipo: historialTipo,
                    monto: monto,
                    de: historialDe,
                    a: historialA,
                    fecha: serverTimestamp()
                });
                
                await batch.commit();
                
            } catch (error) {
                alert("Error al procesar la operaciÃ³n: " + error.message);
            }
        }
    </script>
</body>
</html>